# tfoms-rpn-xml-converter

Временная утилита для преобразования формата xml файлов реестров прикрепленного населения
из текущего формата см. http://new.oms35.ru/upload/Inf_MO_i_SMO/Informazion_vzaim/Izm_Regl_160824.pdf
в предыдущий.

update 26.10.2025: доработка с учетом изменений в регламенте
http://new.oms35.ru/upload/Inf_MO_i_SMO/Informazion_vzaim/Reglament_030925.pdf

### Примеры использования:
Для инициализации файла конфигурации, если требуется внести какие-то изменения:
```
python3 conv.py -inconf
```
Для запуска конвертации:
```
python3 conv.py --file=<путь до xml>/<имя xml>.xml --zip
```
Для удаления записей при повторной обработке:
```
python3 conv.py --file=<путь до xml>/ATM<имя>.xml --flk=<путь до xml>/FATM<имя>.xml --exclude_ids=1,5,7
```

### Особенности использования:
#### Описание ключей запуска:
* --file (-f) - путь к файлу, который нужно преобразовать
* --flk - путь к файлу c ошибками форматно-логистического контроля, которые нужно исправить. Применяется к файлам ATM для
исправления ошибок, как правило удалением некорректных записей, в некоторых случаях переносом в отдельные файлы с иногородними.
* --exclude_ids - исключение конкретных записей, применимо при обработке файлов SZPM, ATM.
* --zip (-z) - флаг сохранения преобразованного файла в одноименный zip архив.
* --init_config (-inconf) - флаг для иниуиализации конфига по-умолчанию. При указании не производится никаких действий, кроме инициализации файла конфигурации.
#### Описание файла конфигурации:
Используется для запуска с разными наборами констант, для конкретной организации. Хранится в формате JSON.
*   `month_packet_counter` - блок счетчика отправленных файлов, для каждого месяца года ведется отдельный счетчик.
    Формат: `"month_packet_counter": {"2025-10": 0, "2025-11": 10}`
*   `code_lpu` - реестровый код организации (см. справочник F032)
*   `allow_save_atm_to_new_package` - логический флаг, для формирования каждой новой итерации правки файла с отдельным номером.
*   `allow_save_atm_to_new_package` - логический флаг, для формирования каждой новой итерации правки файла с отдельным номером.
*   `fap_oids` - список идентификаторов ФАП, которые относятся к организации. Нужен для преобразования файла SZPM на 2 файла прикрепления.
    Формат: `"fap_oids": ["1.2.643.5.1.13.13.12.2.35.3294.0.888888", "1.2.643.5.1.13.13.12.2.35.3294.0.999999"]`


### Настройка:
Для управления зависимоcтями используется uv. Для инициализации окружения предлагается использовать команду ниже.
```
uv sync
```
Либо развернуть виртуальное окружение вручную и взять зависимости из requirements.txt

### Суть процесса:
Файлы преобразуются к необходимому формату и сохраняются в каталог `./converted`
Для PRKS, OZPS файлы ТФОМС преобразуются к формату, который поддерживает МИС.
Для SZPM - файл из МИС преобразуется к файлу, поддерживаемому ТФОМС
согласно спецификации http://new.oms35.ru/upload/Inf_MO_i_SMO/Informazion_vzaim/Reglament_030925.pdf

* Для PRKS:
```
переименовывается тег: ENP -> NPOLIS, 
добавляются теги: <VPOLIS>3</VPOLIS><SPOLIS/>, 
удаляются теги: MD_DEP_ID, AREA_TYPE, DOC_ID, 
меняет версию в заголовке с 1.2 на 1.0 (PRK -> ZGLV -> VERSION)
```

* Для OZPS:
```
переименовывается тег: ENP -> NPOLIS, 
добавляются теги: <VPOLIS>3</VPOLIS><SPOLIS/>, 
убирается расширение из названии файла в ZL_LIST -> ZGLV -> FILENAME, 
меняет версию в заголовке с 1.2 на 1.0 (ZL_LIST -> ZGLV -> VERSION)
```

* Для преобразования SZPM -> ATM
```
Меняем <ZL_LIST> -> <ATT>
В заголовке:
    Меняем:
        <DATE> -> <FDATE>
        <FILENAME> -> <FNAME>
        <VERSION>  1.1 -> 1.3
        <FILENAME> -> <FNAME> + меняем содержимое
    Удаляем: YEAR, MONTH, ZAP
    Добавляем: <AREA_TYPE>1</AREA_TYPE>
В записях:
    Переименовываем тег PERS -> REC
    Меняем:
        <NPOLIS> -> <ENP>
        <DATEZ> -> <DATE_ATTACH_B>
        <PRZ> -> <ATTACH_METHOD> + меняем значение на 2
        В <DOC_CODE> оставляем только цифры.
    Удаляем: PR_NOV, ID_PAC, DOCSER, DOCNUM, VPOLIS, SMO, DOC_POST
```
